// MATRIX 8x8
#include "main.h"

#define SCK &PORTD, PD0
#define LAT &PORTD, PD1
#define DATA &PORTD, PD2

#define MATRIX_WIDTH 40
#define MATRIX_HEIGHT 8

unsigned char FONT[][8] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, //  32
    {0x10, 0x38, 0x38, 0x10, 0x10, 0x00, 0x10}, //! 33
    {0x6C, 0x6C, 0x48, 0x00, 0x00, 0x00, 0x00}, //" 34
    {0x00, 0x28, 0x7C, 0x28, 0x28, 0x7C, 0x28}, //# 35
    {0x20, 0x38, 0x40, 0x30, 0x08, 0x70, 0x10}, //$ 36
    {0x64, 0x64, 0x08, 0x10, 0x20, 0x4C, 0x4C}, //% 37
    {0x20, 0x50, 0x50, 0x20, 0x54, 0x48, 0x34}, //& 38
    {0x30, 0x30, 0x20, 0x00, 0x00, 0x00, 0x00}, //' 39
    {0x10, 0x20, 0x20, 0x20, 0x20, 0x20, 0x10}, //( 40
    {0x20, 0x10, 0x10, 0x10, 0x10, 0x10, 0x20}, //) 41
    {0x00, 0x28, 0x38, 0x7C, 0x38, 0x28, 0x00}, //* 42
    {0x00, 0x10, 0x10, 0x7C, 0x10, 0x10, 0x00}, //+ 43
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30}, //, 44
    {0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00}, //- 45
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30}, //. 46
    {0x00, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00}, /// 47
    {0x38, 0x44, 0x4C, 0x54, 0x64, 0x44, 0x38}, // 0 48
    {0x00, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00}, // 1 49
    {0x38, 0x44, 0x04, 0x18, 0x20, 0x40, 0x7C}, // 2 50
    {0x38, 0x44, 0x04, 0x38, 0x04, 0x44, 0x38}, // 3 51
    {0x08, 0x18, 0x28, 0x48, 0x7C, 0x08, 0x08}, // 4 52
    {0x7C, 0x40, 0x40, 0x78, 0x04, 0x44, 0x38}, // 5 53
    {0x18, 0x20, 0x40, 0x78, 0x44, 0x44, 0x38}, // 6 54
    {0x7C, 0x04, 0x08, 0x10, 0x20, 0x20, 0x20}, // 7 55
    {0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38}, // 8 56
    {0x38, 0x44, 0x44, 0x3C, 0x04, 0x08, 0x30}, // 9 57
    {0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30}, //: 58
    {0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30}, //; 59
    {0x08, 0x10, 0x20, 0x40, 0x20, 0x10, 0x08}, //< 60
    {0x00, 0x00, 0x7C, 0x00, 0x00, 0x7C, 0x00}, //= 61
    {0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20}, //> 62
    {0x38, 0x44, 0x04, 0x18, 0x10, 0x00, 0x10}, //? 63
    {0x38, 0x44, 0x5C, 0x54, 0x5C, 0x40, 0x38}, //@ 64
    {0x38, 0x44, 0x44, 0x44, 0x7C, 0x44, 0x44}, // A 65
    {0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x78}, // B 66
    {0x38, 0x44, 0x40, 0x40, 0x40, 0x44, 0x38}, // C 67
    {0x78, 0x44, 0x44, 0x44, 0x44, 0x44, 0x78}, // D 68
    {0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7C}, // E 69
    {0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40}, // F 70
    {0x38, 0x44, 0x40, 0x5C, 0x44, 0x44, 0x3C}, // G 71
    {0x44, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44}, // H 72
    {0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38}, // I 73
    {0x04, 0x04, 0x04, 0x04, 0x44, 0x44, 0x38}, // J 74
    {0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44}, // K 75
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7C}, // L 76
    {0x44, 0x6C, 0x54, 0x44, 0x44, 0x44, 0x44}, // M 77
    {0x44, 0x64, 0x54, 0x4C, 0x44, 0x44, 0x44}, // N 78
    {0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38}, // O 79
    {0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40}, // P 80
    {0x38, 0x44, 0x44, 0x44, 0x54, 0x48, 0x34}, // Q 81
    {0x78, 0x44, 0x44, 0x78, 0x48, 0x44, 0x44}, // R 82
    {0x38, 0x44, 0x40, 0x38, 0x04, 0x44, 0x38}, // S 83
    {0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10}, // T 84
    {0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38}, // U 85
    {0x44, 0x44, 0x44, 0x44, 0x44, 0x28, 0x10}, // V 86
    {0x44, 0x44, 0x54, 0x54, 0x54, 0x54, 0x28}, // W 87
    {0x44, 0x44, 0x28, 0x10, 0x28, 0x44, 0x44}, // X 88
    {0x44, 0x44, 0x44, 0x28, 0x10, 0x10, 0x10}, // Y 89
    {0x78, 0x08, 0x10, 0x20, 0x40, 0x40, 0x78}, // Z 90
    {0x38, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38}, //[ 91
    {0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x00}, //\ 92
    {0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38}, //] 93
    {0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00}, //^ 94
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C}, //_ 95
    {0x30, 0x30, 0x10, 0x00, 0x00, 0x00, 0x00}, //` 96
    {0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C}, // a 97
    {0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x78}, // b 98
    {0x00, 0x00, 0x38, 0x44, 0x40, 0x44, 0x38}, // c 99
    {0x04, 0x04, 0x3C, 0x44, 0x44, 0x44, 0x3C}, // d 100
    {0x00, 0x00, 0x38, 0x44, 0x78, 0x40, 0x38}, // e 101
    {0x18, 0x20, 0x20, 0x78, 0x20, 0x20, 0x20}, // f 102
    {0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38}, // g 103
    {0x40, 0x40, 0x70, 0x48, 0x48, 0x48, 0x48}, // h 104
    {0x10, 0x00, 0x10, 0x10, 0x10, 0x10, 0x18}, // i 105
    {0x08, 0x00, 0x18, 0x08, 0x08, 0x48, 0x30}, // j 106
    {0x40, 0x40, 0x48, 0x50, 0x60, 0x50, 0x48}, // k 107
    {0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38}, // l 108
    {0x00, 0x00, 0x68, 0x54, 0x54, 0x44, 0x44}, // m 109
    {0x00, 0x00, 0x70, 0x48, 0x48, 0x48, 0x48}, // n 110
    {0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, // o 111
    {0x00, 0x78, 0x44, 0x44, 0x44, 0x78, 0x40}, // p 112
    {0x00, 0x3C, 0x44, 0x44, 0x44, 0x3C, 0x04}, // q 113
    {0x00, 0x00, 0x58, 0x24, 0x20, 0x20, 0x70}, // r 114
    {0x00, 0x00, 0x38, 0x40, 0x38, 0x04, 0x38}, // s 115
    {0x00, 0x20, 0x78, 0x20, 0x20, 0x28, 0x10}, // t 116
    {0x00, 0x00, 0x48, 0x48, 0x48, 0x58, 0x28}, // u 117
    {0x00, 0x00, 0x44, 0x44, 0x44, 0x28, 0x10}, // v 118
    {0x00, 0x00, 0x44, 0x44, 0x54, 0x7C, 0x28}, // w 119
    {0x00, 0x00, 0x48, 0x48, 0x30, 0x48, 0x48}, // x 120
    {0x00, 0x48, 0x48, 0x48, 0x38, 0x10, 0x60}, // y 121
    {0x00, 0x00, 0x78, 0x08, 0x30, 0x40, 0x78}, // z 122
    {0x18, 0x20, 0x20, 0x60, 0x20, 0x20, 0x18}, //{ 123
    {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10}, //| 124
    {0x30, 0x08, 0x08, 0x0C, 0x08, 0x08, 0x30}, //} 125
    {0x00, 0x00, 0x28, 0x50, 0x00, 0x00, 0x00}, //~ 126
};
unsigned char SCAN8x8[8] = {0xFE, 0xFD, 0xFB, 0xF7, 0xEF, 0xDF, 0xBF, 0x7F};
unsigned char BUFFER_DISPLAY[MATRIX_HEIGHT][MATRIX_WIDTH / 8];
unsigned char BUFFER_DISPLAY_TEMP[MATRIX_HEIGHT][MATRIX_WIDTH / 8];

int MATRIX_x, MATRIX_y;

static void GPIO_Init(void);
static void TIMER1_Init(void);
void _74HC595_Out(unsigned char byte);
void MATRIX8x8_SetPosition(int x, int y);
void MATRIX8x8_SetPixel(int x, int y, int status);
void MATRIX8x8_Clear(void);
void MATRIX8x8_Update(void);
void MATRIX8x8_SendChar(char character);
void MATRIX8x8_SendString(char *string);

ISR(TIMER1_OVF_vect)
{
    static unsigned char k;
    PORTB = 0xff;

    for (int x = (MATRIX_WIDTH / 8) - 1; x >= 0; x--)
    {
        _74HC595_Out(BUFFER_DISPLAY_TEMP[k][x]);
    }

    GPIO_WritePin(LAT, 0);
    GPIO_WritePin(LAT, 1);

    PORTB = SCAN8x8[k];
    k++;
    if (k == 8)
        k = 0;

    TCNT1 = 65411;
}

int main()
{
    DS1307 rtc;
    DS1307_SetTime(1, 20, 2);
    DS1307_SetDate(15, 9, 22);
    GPIO_Init();
    TIMER1_Init();

    while (1)
    {
        MATRIX8x8_Clear();
        DS1307_GetDateTime(&rtc);
        MATRIX8x8_SetPosition(0, 0);
        MATRIX8x8_SendChar(rtc.second / 10 + 48);
        MATRIX8x8_Update();
        // MATRIX8x8_Clear();
        // for (int i = MATRIX_WIDTH - 1; i > -200; i--)
        // {
        //   MATRIX8x8_SetPosition(i, 0);
        //   MATRIX8x8_SendString("DOAN KHIET THANH");
        //   MATRIX8x8_Update();
        //   _delay_ms(20);
        // }
    }

    return 0;
}

static void GPIO_Init(void)
{
    DDRB = 0xFF;
    DDRD = 0xFF;
}

static void TIMER1_Init(void)
{
    cli();

    TCCR1A = 0;
    TCCR1B = 0;
    TIMSK1 = 0;
    TCCR1B |= (1 << CS11); // prescale = 8
    TCNT1 = 65411;         // period = 50ms
    TIMSK1 = (1 << TOIE1); // Overflow interrupt enable

    sei();
}

void _74HC595_Out(unsigned char byte)
{
    for (int i = 0; i < 8; i++)
    {
        GPIO_WritePin(DATA, byte & (0x80 >> i));
        GPIO_WritePin(SCK, 0);
        GPIO_WritePin(SCK, 1);
    }
}

void MATRIX8x8_SetPosition(int x, int y)
{
    MATRIX_x = x;
    MATRIX_y = y;
}

void MATRIX8x8_SetPixel(int x, int y, int status)
{
    if (x >= MATRIX_WIDTH || x < 0 || y >= MATRIX_HEIGHT || y < 0)
        return;
    if (status)
        BUFFER_DISPLAY[y][x / 8] |= (0x80 >> (x % 8));
    else
        BUFFER_DISPLAY[y][x / 8] &= ~(0x80 >> (x % 8));
}

void MATRIX8x8_SendChar(char character)
{
    for (int y = MATRIX_y; y < 8 + MATRIX_y; y++)
    {
        for (int x = MATRIX_x; x < 8 + MATRIX_x; x++)
        {
            if ((FONT[character - 32][y - MATRIX_y] & (0x80 >> (x - MATRIX_x))) != 0)
                MATRIX8x8_SetPixel(x, y, 1);
            else
                MATRIX8x8_SetPixel(x, y, 0);
        }
    }

    MATRIX_x += 8;
}

void MATRIX8x8_SendString(char *string)
{
    while (*string)
    {
        MATRIX8x8_SendChar(*string);
        string++;
    }
}

void MATRIX8x8_Clear(void)
{
    for (int y = 0; y < MATRIX_HEIGHT; y++)
    {
        for (int x = 0; x < (MATRIX_WIDTH / 8); x++)
        {
            BUFFER_DISPLAY_TEMP[y][x] = 0;
        }
    }
}

void MATRIX8x8_Update(void)
{
    for (int y = 0; y < MATRIX_HEIGHT; y++)
    {
        for (int x = 0; x < (MATRIX_WIDTH / 8); x++)
        {
            BUFFER_DISPLAY_TEMP[y][x] = BUFFER_DISPLAY[y][x];
        }
    }
}
